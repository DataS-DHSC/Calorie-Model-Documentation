# Technical Annex {}

The current version of the calorie model is **version 2**. The model is at `\\ims.gov.uk\DHSC\London\SKH\NW012\EOR3\COP\Calorie Model 2`, this folder contains an `R project` file and main 3 sub folders;

- `/src` - a folder than contains all the model code files

- `/heemod data` - a folder that contains all the model parameters and data

- `/data` - a folder that contains all the background data (demographics, baseline BMI and baseline moratily rates)

## Model Code -`/src`

**The structture as shown below has not yet been fully tested and agreed**

The code for the calorie model is contained in a number of R files in the subfolder `/src`. These code files are in 5 sub directaries; [Model code], [Model analysis], [Equations], [Setup code] and [Experimental models].

### Model code

This sub directary contains the main code file for the model; `calorie model 2.0.1.R`
 
#### calorie model 2.0.2.R {-}

This is the main code file for the model, it is in 4 main sections:

- Section 1 - model front end
This version of the model includes a simple front end that consists of a series of pop-up boxes that colect all the user deffined model parameters for a new model run.

- Section 2 - set up treatment group
This section is contained within the function `bmi_simulate`. It reads in the data contained in the counterfactual.csv files, modifies the calorie intake by the calorie reduction specified and writes out the treatment group in the treat.csv file.

- Section 3 - run model
This section runs the markov model using the parameter defined in the [heemod data][Model Parameters and Data -`/heemod data`] via the command `run_heemod_tabular`.

- Section 4 - perform analysis and save model
This section creates a new sub-folder called `model` to save the model.rds file in and calls the model analysis code that creates a new sub-folder called `report` to save the summary model report in.

### Model analysis

This sub directary contains code to analyse a saved model; `model analysis.R` and `model analysis.Rmd` 

#### model analysis.R {-}

This file is called by [section 4 of the main model code file][calorie model 2.0.2.R]. It performs a set of summary analysis on the markov model and creates the new sub-folder `report` to save the summary analysis report to.

#### model analysis.Rmd {-}

This file is called by the [model analysis file][model analysis.R]. It uses the analysis generated by the model analysis file to write a summary report that is then saved to the new `report` sub-folder.

### Equations

This sub directary contains code to solve the equations used by the calorie model; `hall eqn.R` and `background functions.R`. These codes provide functions used by many other files, users should not in anyway change this dirctary.
 
#### hall eqn.R {-}

This code file contains a set of functions that give numeric solutions to the hall equations.

#### background functions.R {-}

This code file contains a set of functions that are used in a number of other files to
help solve the Hall equations.

### Setup code

This sub directary contains code to generate the additional data that goes into the calorie model; `connvert_incorect_ref_to_correct_ref.R`, `generate discount rates.R`, `generate I_ref.R`, `generate transition matrix`, `generate_lookup_tables.R`, `generate_lookup_tables_2_find_best_data`, `verbose_tabular_heemod` and `merge_population_sizes_generate_counterfactual.R`. These code are used to help in the production of the fixed model input parameters, they should not be used other than for detailed model development work.

## Model Parameters and Data -`/heemod data`

The markov model is run via the function `run_model_tabular` using the tabular data contained in a number of csv files in the subfolder `/heemod data`, these files contain all input data and parameters requiered to run the markov model as implemented by heemod. The main tabular files required by the function `run_model_tabular` are described in the [heemod vignettes](https://cran.r-project.org/web/packages/heemod/vignettes/h_tabular.html) and the specific files used for the calorie model are listed below:

#### REFERENCE.csv {-}

This is an 'umbrella' file that specifies the files and sub decectaries used by the function `run_model_from_tabular`. It consists of two columns; `data` and `file` that specify the data needed by the markov model and the files od sub directaries in which the data is contained:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame(data = c('state',
                           'tm',
                           'parameter',
                           'data',
                           'options',
                           'demographics'),
                  file = c('state.csv',
                           'tm.csv',
                           'parameter.csv',
                           'additional parameters',
                           'options.csv',
                           'demographics.csv'))) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### options.csv {-} 

This is a file specifying options to be used by the model. It consists of two columns; `option` and `value`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('option',
                                    'value'),
                  'Column Meaning' = c('the heemod option',
                                       'the value of the option'))) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### parameters.csv {-}

This is a file specifying parameters to be used in the model. It consists of two columns; `parameter` and `value`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('parameter',
                                    'value'),
                  'Column Meaning' = c('the markov model parameter',
                                       'the value of the parameter'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### tm.csv {-} 

This is a file specifying the transition probabilities to be used in the model. It consists of 4 columns; `.model`, `from`, `to` and `prob`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('.model',
                                    'from',
                                    'to',
                                    'prob'),
                  'Column Meaning' = c('the model this row relates to',
                                       'the state the transition probability is from',
                                       'the state the transition probability is to',
                                       'the value of the transition probability (C: 1 - all other relevent probabilities)'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### state.csv {-}

This is a file specifying parameters to be used in the model. It consists of 10 columns; `.model`, `.state`, `nhs_cost`, `qaly`, `social_cost`, `earnings`, `nhs_disc`, `qaly_disc`, `social_disc` and `earnings_disc`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('.model',
                                    '.state',
                                    'nhs_cost',
                                    'qaly',
                                    'social_cost',
                                    'earnings',
                                    'nhs_disc',
                                    'qaly_disc',
                                    'social_disc',
                                    'earnings_disc'),
                  'Column Meaning' = c('the model this row relates to',
                                       'the state this row relates to',
                                       'the NHS costs of the state',
                                       'the QALY value of the state ',
                                       'the social care costs of the state',
                                       'the earings value of the state',
                                       'the discounted NHS costs of the state',
                                       'the discounted QALY value of the state ',
                                       'the discounted social care costs of the state',
                                       'the discounted earings value of the state'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### demograpics.csv {-}

This is a file specifying the initial demographics to be used in the model. It consists of 4 columns; `initial_age`, `sex`, `cut_bmi` and `.weights`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('initial_age', 
                                   'sex', 
                                   'cut_bmi',
                                   '.weights'),
                  'Column Meaning' = c('the age of an indervidual in that row at the sart of the model run  ',
                                      'the sex of an indervidual in that row \n(1 = male, 2 = female)',
                                      'the BMI category of an indervidual in that row (1 = underweight, 2 = healthy weight, 3 = overweight, 4 = obese, 5 = morbidly obese)',
                                      'the number of inderviduals representend by this row'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

### Additional Data

The sub directory `/additional params` contains a number of CSV file with tabular data. The tabular data contained within the CSV files can be accessed by internal equations within the markov model (such as the state parameter and transition probabilities given in [state.csv] and [tm.csv]) by using the `look_up` fuction.

#### average_earning.csv {-}

This file contains male and female average earnings data. It consists of 3 columns; `age`, `sex` and `earnings`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('age', 
                                    'sex', 
                                    'earnings'),
                  'Column Meaning' = c('the age of an indervidual in that row',
                                       'the sex of an indervidual in that row \n(1 = male, 2 = female)',
                                      'the average salary (in &pound;) of an indervidual in that row'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### discount_rate.csv {-}

This file cotains the health and general discount rates data upto a 125 year time horizon. It consists of 3 columns; `year`, `type` and `discount_rate`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('year', 
                                    'type', 
                                    'dicount_rate'),
                  'Column Meaning' = c('the year in the future the row applies to',
                                       'the type of discount rate (health or general)',
                                      'the relevent discount rate'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```


#### counterfactual.csv {-}

This file contains the demographic and BMI trajectories data for the counterfactual (non treatment) group. It consists of 17 columns; `age`, `FM`, `FFM`,`weight`, `bmi`, `I`, `I_ref`, `multiplier`, `sex`, `percentile`, `refrence_bmi`, `error`, `initial_age`, `wt`, `cut_bmi`, `year` and `population`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('age', 
                                    'FM',
                                    'FFM',
                                    'weight',
                                    'bmi',
                                    'I',
                                    'I_ref', 
                                    'multiplier',
                                    'sex', 
                                    'percentile',
                                    'refrence_bmi',
                                    'error',
                                    'initial_age',
                                    'wt',
                                    'cut_bmi',
                                    'year',
                                    'population'),
                  'Column Meaning' = c('the age of an indervidual in that row',
                                       'the fatty mass of an indervidual in that row',
                                       'the fat free mass of an indervidual in that row',
                                       'the weight of an indervidual in that row',
                                       'the BMI of an indervidual in that row',
                                       'the daily Kcal intake of an indervidual in that row',
                                       'the reference daily Kcal intake of an indervidual in that row',
                                       '',
                                       'the sex of an indervidual \n(1 = male, 2 = female)',
                                       '',
                                       '',
                                       '',
                                       'the age an indevidual in that row starts in the model',
                                       'the proportion of this age/sex group of this row that is in the BMI category',
                                       'the BMI category of an indervidual in that row',
                                       'the year the demographic predictions in that row relate to',
                                       'the predicted population of the demographic group that row relates to'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### employment.csv {-}

This file contains male and female average employment rate data. It consists of 3 columns; `age`, `sex` and `employment_rate`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('age', 
                                    'sex', 
                                    'employment_rate'),
                  'Column Meaning' = c('the age of an indervidual in that row',
                                       'the sex of an indervidual in that row \n(1 = male, 2 = female)',
                                      'the employment rate of this deographic'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### incidence_and_risk.csv {-}

This file contains male and female disease incidence and mortality data. It consists of 6 columns; `age`, `sex`, `condition`, `incidence`, `mortality_uplift` and `delta_incidence`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('age', 
                                    'sex', 
                                    'condition',
                                    'incidence',
                                    'mortality_uplift',
                                    'delta_incidence'),
                  'Column Meaning' = c('the age of an indervidual in that row',
                                       'the sex of an indervidual in that rowl \n(1 = male, 2 = female)',
                                       'the condition this row relates to',
                                       'the base incidence of this condition',
                                       'the rise in mortality caused by this condition',
                                       'the increase in the incidence of this condition caused by high BMI'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### mr.csv {-}

This file contains male and female baseline mortality rate, the mortality rate in the general population. It consists of 3 columns; `age`, `sex` and `mort`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('age', 
                                    'sex', 
                                    'mort'),
                  'Column Meaning' = c('the age of an indervidual in that row',
                                       'the sex of an indervidual in that row \n(1 = male, 2 = female)',
                                       'the baseline mortality rate of this deographic'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

#### treat.csv {-}

This file contains the demographic and BMI trajectories data for the treatment group, the population subject to the policy being modeled. It is the output of section 1 of the code file [calorie model 2.0.1.R] and consists of 11 columns; `age`, `FM`, `FFM`, `weight`, `bmi`, `initial_age`, `wt`, `sex`, `cut_bmi`, `year` and `population`:

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.width=5}
 kable(data.frame('Column Name' = c('age', 
                                    'FM', 
                                    'FFM',
                                    'weight',
                                    'bmi',
                                    'initial_age',
                                    'wt',
                                    'sex', 
                                    'cut_bmi',
                                    'year',
                                    'population'),
                  'Column Meaning' = c('the age of an indervidual in that row',
                                       'the fatty mass of an indervidual in that row',
                                       'the fat free mass of an indervidual in that row',
                                       'the weight of an indervidual in that row',
                                       'the BMI of an indervidual in that row',
                                       'the age an indevidual in that row starts in the model',
                                       'the proportion of this age/sex group of this row that is in the BMI category',
                                       'the sex of an indervidual in that row \n(1 = male, 2 = female)',
                                       'the BMI category of an indervidual in that row',
                                       'the year the demographic predictions in that row relate to',
                                       'the predicted population of the demographic group that row relates to'))) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12,full_width = FALSE) 
```

## Other Model Data - `/data`

Contains thes sub directary `master_hemod_data` that contains the unfiltered full counterfactual and demographic data files.

A list and description of the other data sets that are used by the calorie model. 